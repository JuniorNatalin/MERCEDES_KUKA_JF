&ACCESS RVO11
&REL 185
&COMMENT MB-SpotWeld V4.14U
&PARAM DISKPATH = KRC:\R1\TP\DAI_AG_Spot
DEFDAT  userspot PUBLIC
;date:2012-07-01 #Bst

DECL CONST BOOL OPT_USRSPOT=TRUE
;fold DC-Userspot V 4.xx
;Fold Types
GLOBAL STRUC ZANGENDATTYP BOOL VORHANDEN,INT Z_TYP,BOOL Stationaer,INT Z_ANZ,BOOL VORHUB,INT WKZ_AB,INT Z_EA_NR,MaxStandmenge,FraesAnf,INT FRAESER,INT EL_NR,INT VSST,INT PRMAXDR
STRUC Z_E_ADATTYP INT O_VH_ZU,INT O_VH_AUF,INT O_SH,INT O_RH,INT I_VH_AUF,INT I_VH_ZU,I_SH_AUF,I_SH_ZU,INT I_SW_MIN,INT I_SW_MAX,INT I_TK
STRUC FRAESDATTYP INT FRAES_SST,INT FRAES_START,INT FRAES_DREHT,INT TWIN_DREHT,INT FRAES_FERTIG,INT FRAES_F,INT ZANGE_ZU,INT I_MMS,INT I_KONTROLL,INT I_SCHWENK_VOR,INT I_SCHWENK_ZUR,INT O_SCHWENK_VOR,INT O_SCHWENK_ZUR
STRUC FRAES_PARAMETERDATTYP INT EF_UM_KAP,INT FF_UM_KAP,INT EF_PROG,INT FF_PROG,INT Ef_Twin_Prog,INT Ff_Twin_Prog,BOOL FRAESER_SCHWENKEN,BOOL TWIN_FRAESER,BOOL STEP_DRESS,INT STEP_TURN,INT TURN_TWIN_FF,INT TURN_TWIN_EF,INT MAX_DRESS_TIME,REAL PAST_TIME
STRUC SSTDATTYP INT O_SKSTART,O_QFAL,O_QFFK,O_QFPW,O_MSTROM,O_QELW,O_QFRAES,O_BTEnd,O_RefWNEl,O_RefWFraes,O_UebWSchw,I_FK,I_ZPSBEREIT,I_SchwFehl,I_OHNEUEBWACH,I_MSTROM,I_VorWarn,I_MaxStandMenge,I_FRAESEN,I_StartFraesAnfrage,I_NeueEl,I_QBTEnd,I_RefWAct,I_FraesErr,I_UWSchwAct,I_QErrFK,I_QErrPktW,I_FraesNotw,I_PktAnwOK
;endfold (Types)
DECL CONST INT MAX_ZANGKENN=4
; Gueltige Werte fuer Zangentyp:
; 1 = C-Zange Standard Typ 
; 2 = X-Zange Variante mit 2 doppeltwirkenden Zylinder
; 3 = SE-Zange (nur f???r Bremen)
; 4 = C-Zange bei der der Vorhub nicht getrennt vom Schwei???hub zur???ckgefahren werden kann (sonst wie Typ 1)
; 
DECL GLOBAL ZANGENDATTYP ZANGE[10]
ZANGE[1]={VORHANDEN TRUE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 161,Z_EA_NR 1,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 1,VSST 1,PRMAXDR 251}
ZANGE[2]={VORHANDEN TRUE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 177,Z_EA_NR 1,MaxStandmenge 0,FraesAnf -1,FRAESER 1,EL_NR 2,VSST 1,PRMAXDR 252}
ZANGE[3]={VORHANDEN TRUE,Z_TYP 2,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 169,Z_EA_NR 1,MaxStandmenge 0,FraesAnf -1,FRAESER 1,EL_NR 3,VSST 1,PRMAXDR 253}
ZANGE[4]={VORHANDEN TRUE,Z_TYP 2,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 185,Z_EA_NR 3,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 4,VSST 1,PRMAXDR 254}
ZANGE[5]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 1,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}
ZANGE[6]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 0,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}
ZANGE[7]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 0,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}
ZANGE[8]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 0,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}
ZANGE[9]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 0,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}
ZANGE[10]={VORHANDEN FALSE,Z_TYP 1,Stationaer FALSE,Z_ANZ 1,VORHUB TRUE,WKZ_AB 0,Z_EA_NR 0,MaxStandmenge 0,FraesAnf 0,FRAESER 1,EL_NR 0,VSST 0,PRMAXDR 250}



;// User Settings
DECL BOOL OPT_USRSPOT_SIMULATE=FALSE ;wenn TRUE wird nur Vorhub ausgef???hrt
DECL BOOL Opt_GetGunNr=TRUE ;Zangennummer aus Bahnhofsbelgung ermitteln
DECL BOOL OPT_T1_CLOSE=TRUE
DECL BOOL T1_WithWeld=TRUE ;// In mode T1 with Weldprocess
DECL BOOL WithMaxPressure=FALSE ;// In case of old X-Gun
DECL BOOL OPT_MIT_STR=TRUE
DECL BOOL OPT_EL_NR=TRUE ;// Need for Bug in old Bosch controller
DECL CONST INT Max_Weld_Repeat=2 ;anzahl wiederholung nach fehlschweissung
DECL INT MaxStandmengeDelay=0 ;// Anzahl Verzoegerung bis nach MaxStandmenge bis Rob stoppt
DECL INT FraesAnfDelay=0 ;// Anzahl Verzoegerung bis rob selbst. zum freas. 
DECL INT TWIN=0 ;Merker fuer den Twin Fraeser
DECL INT UM_KAP=5 ;Merker fuer die Umdrehungen
DECL INT AZ=1 ;aktuelle Zange
DECL CONST INT I_WKZAN=219 ;Eingang von Dockplatte fuer Werkzeug angedockt
DECL CONST INT I_HALTNACHPUNKT=817
DECL CONST INT O_HALTNACHPUNKTERREICHT=817
DECL INT Key_No=1 ;used Statkey No.

DECL BOOL IniDress=FALSE ;// For JDF Truck reuse

;================ Variablen fuer E/A-Belegung SST =================
;// Status Info an SPS
DECL INT PS_Rob_Vorwarnung=0 ;//Elektr.-Vorwarnung erreicht Rob.-Zange
DECL INT PS_Rob_E_GrpWechs=0 ;//Elektr.-Wechsel erforderlich Rob.-Zange
DECL INT PS_Rob_MaxStandmenge=0 ;//Elektr.-Max Standmenge erreicht Rob.-Zange
DECL INT PS_Rob_Fraesanf=0 ;//Elektr.-Bereitschaft GruppenFraesen Rob.-Zange
DECL INT PS_Rob_FraesErf=0 ;//Elektr.-Fraesen zwingend erfoderlich Rob.-Zange
DECL INT PS_Stat_Vorwarnung=0 ;//Elektr.-Vorwarnung erreicht Stat.-Zange         
DECL INT PS_Stat_E_GrpWechs=0 ;//Elektr.-Wechsel erforderlich Stat.-Zange        
DECL INT PS_Stat_MaxStandmenge=0 ;//Elektr.-Max Standmenge erreicht Stat.-Zange     
DECL INT PS_Stat_Fraesanf=0 ;//Elektr.-Bereitschaft GruppenFraesen Stat.-Zange 
DECL INT PS_Stat_FraesErf=0 ;//Elektr.-Fraesen zwingend erfoderlich Stat.-Zange
DECL INT O_KAPPENWECHSELPOS=0 ;//Roboter in E-Wechselposition
DECL INT I_FRAESANFSPS=1026 ;// Anford. Fraes von SPS. 
DECL CONST INT MAX_SST=1
DECL CONST SSTDATTYP SST[4]
SST[1]={O_SKSTART 225,O_QFAL 229,O_QFFK 227,O_QFPW 231,O_MSTROM 232,O_QELW 0,O_QFRAES 226,O_BTEnd 0,O_RefWNEl 0,O_RefWFraes 0,O_UebWSchw 0,I_FK 225,I_ZPSBEREIT 229,I_SchwFehl 230,I_OHNEUEBWACH 231,I_MSTROM 232,I_VorWarn 227,I_MaxStandMenge 228,I_FRAESEN 226,I_StartFraesAnfrage 1026,I_NeueEl 0,I_QBTEnd 1026,I_RefWAct 1026,I_FraesErr 1026,I_UWSchwAct 1026,I_QErrFK 1026,I_QErrPktW 1026,I_FraesNotw 1026,I_PktAnwOK 1025}
SST[2]={O_SKSTART 225,O_QFAL 226,O_QFFK 227,O_QFPW 228,O_MSTROM 229,O_QELW 232,O_QFRAES 233,O_BTEnd 247,O_RefWNEl 250,O_RefWFraes 251,O_UebWSchw 252,I_FK 225,I_ZPSBEREIT 226,I_SchwFehl 227,I_OHNEUEBWACH 228,I_MSTROM 229,I_VorWarn 231,I_MaxStandMenge 232,I_FRAESEN 233,I_StartFraesAnfrage 234,I_NeueEl 235,I_QBTEnd 247,I_RefWAct 250,I_FraesErr 251,I_UWSchwAct 252,I_QErrFK 255,I_QErrPktW 256,I_FraesNotw 281,I_PktAnwOK 288}
SST[3]={O_SKSTART 225,O_QFAL 226,O_QFFK 227,O_QFPW 228,O_MSTROM 229,O_QELW 232,O_QFRAES 233,O_BTEnd 247,O_RefWNEl 250,O_RefWFraes 251,O_UebWSchw 252,I_FK 225,I_ZPSBEREIT 226,I_SchwFehl 227,I_OHNEUEBWACH 228,I_MSTROM 229,I_VorWarn 231,I_MaxStandMenge 232,I_FRAESEN 233,I_StartFraesAnfrage 234,I_NeueEl 235,I_QBTEnd 247,I_RefWAct 250,I_FraesErr 251,I_UWSchwAct 252,I_QErrFK 255,I_QErrPktW 256,I_FraesNotw 281,I_PktAnwOK 288}
SST[4]={O_SKSTART 225,O_QFAL 226,O_QFFK 227,O_QFPW 228,O_MSTROM 229,O_QELW 232,O_QFRAES 233,O_BTEnd 247,O_RefWNEl 250,O_RefWFraes 251,O_UebWSchw 252,I_FK 225,I_ZPSBEREIT 226,I_SchwFehl 227,I_OHNEUEBWACH 228,I_MSTROM 229,I_VorWarn 231,I_MaxStandMenge 232,I_FRAESEN 233,I_StartFraesAnfrage 234,I_NeueEl 235,I_QBTEnd 247,I_RefWAct 250,I_FraesErr 251,I_UWSchwAct 252,I_QErrFK 255,I_QErrPktW 256,I_FraesNotw 281,I_PktAnwOK 288}


;================= Variablen fuer Fraeserkennung ==================
DECL CONST INT MAX_FRAESER=2
DECL CONST FRAESDATTYP FRAESER[6] ; FRAES_SST => Zuordnung zur SST, 0 = extra Fr???ser ausserhalb vom SST
FRAESER[1]={FRAES_SST 0,FRAES_START 119,FRAES_DREHT 120,TWIN_DREHT 1026,FRAES_FERTIG 0,FRAES_F 0,ZANGE_ZU 239,I_MMS 241,I_KONTROLL 243,I_SCHWENK_VOR 118,I_SCHWENK_ZUR 116,O_SCHWENK_VOR 117,O_SCHWENK_ZUR 115}
FRAESER[2]={FRAES_SST 0,FRAES_START 135,FRAES_DREHT 136,TWIN_DREHT 1026,FRAES_FERTIG 0,FRAES_F 0,ZANGE_ZU 245,I_MMS 241,I_KONTROLL 249,I_SCHWENK_VOR 134,I_SCHWENK_ZUR 132,O_SCHWENK_VOR 133,O_SCHWENK_ZUR 131}
FRAESER[3]={FRAES_SST 2,FRAES_START 206,FRAES_DREHT 206,TWIN_DREHT 1026,FRAES_FERTIG 207,FRAES_F 208,ZANGE_ZU 207,I_MMS 209,I_KONTROLL 211,I_SCHWENK_VOR 1026,I_SCHWENK_ZUR 1025,O_SCHWENK_VOR 1026,O_SCHWENK_ZUR 1026}
FRAESER[4]={FRAES_SST 2,FRAES_START 212,FRAES_DREHT 212,TWIN_DREHT 1026,FRAES_FERTIG 213,FRAES_F 214,ZANGE_ZU 213,I_MMS 209,I_KONTROLL 217,I_SCHWENK_VOR 1026,I_SCHWENK_ZUR 1025,O_SCHWENK_VOR 1026,O_SCHWENK_ZUR 1026}
FRAESER[5]={FRAES_SST 0,FRAES_START 1026,FRAES_DREHT 1026,TWIN_DREHT 1026,FRAES_FERTIG 1026,FRAES_F 1026,I_MMS 1026,I_SCHWENK_VOR 1026,I_SCHWENK_ZUR 1025,O_SCHWENK_VOR 1026,O_SCHWENK_ZUR 1026}
FRAESER[6]={FRAES_SST 0,FRAES_START 1026,FRAES_DREHT 1026,TWIN_DREHT 1026,FRAES_FERTIG 1026,FRAES_F 1026,I_MMS 1026,I_SCHWENK_VOR 1026,I_SCHWENK_ZUR 1025,O_SCHWENK_VOR 1026,O_SCHWENK_ZUR 1026}

;================= Variablen fuer Fraeserparameter ===================

DECL CONST INT MAX_PARAMETER=6
DECL FRAES_PARAMETERDATTYP PARAMETER[6] ; 
PARAMETER[1]={EF_UM_KAP 10,FF_UM_KAP 5,EF_PROG 241,FF_PROG 242,Ef_Twin_Prog 241,Ff_Twin_Prog 241,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 5,TURN_TWIN_EF 5,MAX_DRESS_TIME 15,PAST_TIME 3.0}
PARAMETER[2]={EF_UM_KAP 10,FF_UM_KAP 5,EF_PROG 243,FF_PROG 244,Ef_Twin_Prog 241,Ff_Twin_Prog 241,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 5,TURN_TWIN_EF 5,MAX_DRESS_TIME 15,PAST_TIME 3.0}
PARAMETER[3]={EF_UM_KAP 10,FF_UM_KAP 5,EF_PROG 245,FF_PROG 246,Ef_Twin_Prog 241,Ff_Twin_Prog 241,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 5,TURN_TWIN_EF 5,MAX_DRESS_TIME 15,PAST_TIME 3.0}
PARAMETER[4]={EF_UM_KAP 10,FF_UM_KAP 5,EF_PROG 247,FF_PROG 248,Ef_Twin_Prog 241,Ff_Twin_Prog 241,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 5,TURN_TWIN_EF 5,MAX_DRESS_TIME 30,PAST_TIME 3.0}
PARAMETER[5]={EF_UM_KAP 0,FF_UM_KAP 0,EF_PROG 0,FF_PROG 0,Ef_Twin_Prog 0,Ff_Twin_Prog 0,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 0,TURN_TWIN_EF 0,MAX_DRESS_TIME 30,PAST_TIME 3.0}
PARAMETER[6]={EF_UM_KAP 0,FF_UM_KAP 0,EF_PROG 0,FF_PROG 0,Ef_Twin_Prog 0,Ff_Twin_Prog 0,FRAESER_SCHWENKEN FALSE,TWIN_FRAESER FALSE,STEP_DRESS TRUE,STEP_TURN 10,TURN_TWIN_FF 0,TURN_TWIN_EF 0,MAX_DRESS_TIME 30,PAST_TIME 3.0}

;================= Variablen fuer Zangenkennung ===================

;=============== Variablen fuer E/A-Belegung Zange ================

DECL CONST INT MAX_Z_E_A=3
DECL Z_E_ADATTYP Z_E_A[5]
; 
;===============================================
; Foram alterados os parametros a seguir da Pinca C1 e C2.
; Pois ambos possuem 1 sensor (I_VH_AUF-> INPUT 69) QUE INDICA PINCA PARA TRAS.
; 
; I_VH_ZU (INPUT 71) -> Pinca (n) Avanca na Frente
; I_SH_AUF (INPUT 70) -> Pinca (n) Curso de Solda Aberto
; 
;===============================================
Z_E_A[1]={O_VH_ZU 65,O_VH_AUF 68,O_SH 66,O_RH 999,I_VH_AUF 69,I_VH_ZU 0,I_SH_AUF 0,I_SH_ZU 1025,I_SW_MIN 67,I_SW_MAX 1025,I_TK 1025}

Z_E_A[2]={O_VH_ZU 65,O_VH_AUF 68,O_SH 66,O_RH 999,I_VH_AUF 69,I_VH_ZU 0,I_SH_AUF 0,I_SH_ZU 1025,I_SW_MIN 83,I_SW_MAX 1025,I_TK 1025}

Z_E_A[3]={O_VH_ZU 999,O_VH_AUF 999,O_SH 66,O_RH 999,I_VH_AUF 0,I_VH_ZU 0,I_SH_AUF 69,I_SH_ZU 1025,I_SW_MIN 67,I_SW_MAX 1025,I_TK 1025}

Z_E_A[4]={O_VH_ZU 999,O_VH_AUF 999,O_SH 999,O_RH 1026,I_VH_AUF 117,I_VH_ZU 121,I_SH_AUF 119,I_SH_ZU 1025,I_SW_MIN 145,I_SW_MAX 1025,I_TK 102}

Z_E_A[5]={O_VH_ZU 999,O_VH_AUF 999,O_SH 999,O_RH 1026,I_VH_AUF 117,I_VH_ZU 121,I_SH_AUF 119,I_SH_ZU 1025,I_SW_MIN 145,I_SW_MAX 1025,I_TK 102}


DECL BOOL FraesAnford[10]
FraesAnford[1]=TRUE
FraesAnford[2]=TRUE
FraesAnford[3]=TRUE
FraesAnford[4]=TRUE
FraesAnford[5]=FALSE
FraesAnford[6]=FALSE
FraesAnford[7]=FALSE
FraesAnford[8]=FALSE
FraesAnford[9]=FALSE
FraesAnford[10]=FALSE
INT ERROR_PRG=0

SIGNAL O_PROGRAMM_A $OUT[233]  TO $OUT[240] ;Schwei???steuerung 1
SIGNAL O_PROGRAMM_B $OUT[233]  TO $OUT[240] ;Schwei???steuerung 2
SIGNAL O_PROGRAMM_C $OUT[233]  TO $OUT[240]
SIGNAL O_PROGRAMM_D $OUT[233]  TO $OUT[240]


;//--- RunTime ---
INT II=6
INT ZA=1
INT AY=3
INT TIMEOUT=3
DECL REAL AG_GhostDelay=2.0
DECL CONST INT FK_WAIT_TIME=5000 ;Wartezeit auf FK in ms
DECL CONST INT FRAESER_KLEMMT_TIME=500 ;???berwachungszeit f???r Fr???ser klemmt in ms
DECL CONST INT FRAESER_KLEMMT_MAX=2 ;Anzahl Fr???serverklemmungen bevor Dialog kommt
DECL INT TURN_ACT=5 ;act.turns of dresser
DECL INT sign_err[4]
sign_err[1]=6 ;Dress error tip 1 
sign_err[2]=0 ;Dress error tip 2 
sign_err[3]=1 ;Dress error tip 3 
sign_err[4]=26 ;Dress error tip 4 


DECL CHAR AG_STRDEST[5]
DECL BOOL AG_bHndl
DECL INT AG_Answer,AG_Offset,AG_MSGHandle
DECL INT Ti2=12
DECL INT Ti3=13
DECL INT Ti4=14
ENDDAT